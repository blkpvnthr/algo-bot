<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scripts</title>

  <style>
    :root{
      --bg:#05060a;
      --panel:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:#eef0ff;
      --muted:rgba(238,240,255,.70);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --accent: rgba(34,211,238,.9);
      --accent2: rgba(99,102,241,.9);
      --good: rgba(16,185,129,.95);
      --warn: rgba(245,158,11,.95);
      --danger: rgba(239,68,68,.95);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 700px at 40% 110%, rgba(244,63,94,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
    }

    /* ===== Page Layout ===== */
    .page{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    .headerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 8px 0 14px;
    }

    .crumbs{
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(238,240,255,.80);
      font-size: 13px;
      flex-wrap: wrap;
    }
    .crumbs a{
      color: rgba(233,238,251,.86);
      text-decoration:none;
      border-bottom: 1px dashed rgba(255,255,255,.16);
    }
    .crumbs a:hover{ border-bottom-color: rgba(255,255,255,.35); }
    .crumbs .sep{ opacity:.45; }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing:.2px;
      transition: .15s ease;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.07); }
    .btn.primary{
      border-color: rgba(34,211,238,.35);
      background: linear-gradient(135deg, rgba(34,211,238,.16), rgba(99,102,241,.10));
    }
    .btn.good{
      border-color: rgba(16,185,129,.35);
      background: linear-gradient(135deg, rgba(16,185,129,.18), rgba(34,211,238,.06));
    }

    .layout{
      display:grid;
      grid-template-columns: 1.35fr .85fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 1100px){
      .layout{ grid-template-columns: 1fr; }
    }

    /* ===== Panels ===== */
    .panel{
      border: 1px solid var(--line);
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-220px -260px auto auto;
      width: 520px;
      height: 520px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), transparent 55%);
      transform: rotate(12deg);
      pointer-events:none;
      opacity:.60;
    }

    .panelHead{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.18);
    }

    .panelTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .dotLamp{
      width: 10px;
      height: 10px;
      border-radius: 99px;
      background: rgba(255,255,255,.28);
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
    }

    .panelTitle strong{
      font-size: 14px;
      letter-spacing:.2px;
    }

    .smallMeta{
      font-size: 12px;
      color: rgba(238,240,255,.70);
      white-space: nowrap;
    }

    .pill{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      padding: 6px 10px;
      border-radius: 999px;
      color: rgba(238,240,255,.86);
      display:inline-flex;
      gap:8px;
      align-items:center;
      white-space: nowrap;
    }

    /* ===== Editor ===== */
    .editor{
      width: 100%;
      min-height: 56vh;
      padding: 14px 14px 18px;
      background: rgba(0,0,0,.25);
      color: rgba(238,240,255,.92);
      border: none;
      outline: none;
      resize: none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.5;
      tab-size: 2;
    }

    .editorFoot{
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: rgba(238,240,255,.70);
      flex-wrap: wrap;
    }

    /* ===== NEW: Editor grid + mini panels ===== */
    .editorGrid{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-rows: auto auto;
    }

    .lowerRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    @media (max-width: 900px){
      .lowerRow{ grid-template-columns: 1fr; }
    }

    .miniPanel{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      overflow:hidden;
    }

    .miniHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      font-size: 12px;
    }

    .miniBody{
      padding: 10px;
    }

    .feed{
      height: 210px;
      overflow:auto;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(238,240,255,.88);
      white-space: pre-wrap;
    }

    .canvasWrap canvas{
      width: 100%;
      height: auto;
      display:block;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
    }

    /* ===== Right Tabs ===== */
    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      position:relative;
      z-index:1;
    }

    .tab{
      cursor:pointer;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: rgba(233,238,251,.86);
      background: rgba(255,255,255,.00);
      transition: .15s ease;
      user-select:none;
      font-weight: 800;
    }
    .tab:hover{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transform: translateY(-1px);
    }
    .tab.active{
      border-color: rgba(34,211,238,.35);
      background: linear-gradient(135deg, rgba(34,211,238,.12), rgba(99,102,241,.08));
      color: rgba(255,255,255,.95);
    }

    .tabBody{
      position:relative;
      z-index:1;
      padding: 12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 1100px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: rgba(238,240,255,.70);
      margin-bottom: 6px;
      font-weight: 800;
      letter-spacing:.2px;
    }

    .input, select, textarea.input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    .input:focus, select:focus, textarea.input:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(99,102,241,.14);
    }

    .runRow{
      display:flex;
      align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn.run{
      border-color: rgba(99,102,241,.35);
      background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(34,211,238,.06));
      padding: 10px 16px;
    }

    .helper{
      font-size: 12px;
      color: rgba(238,240,255,.65);
      line-height: 1.45;
    }

    /* ===== Output ===== */
    .output{
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,.24);
      padding: 10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(238,240,255,.88);
      white-space: pre-wrap;
      min-height: 140px;
    }

    .muted{ color: rgba(238,240,255,.70); }
    .k{ color: rgba(34,211,238,.95); font-weight: 900; }

    /* ===== Glass Navbar ===== */
    .navbar{
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--line);
      background: rgba(10,16,30,.45);
      backdrop-filter: blur(14px);
    }

    .navbar .navwrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }

    .navLeft{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 220px;
    }

    .navTitle{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .navTitle strong{
      font-size: 14px;
      letter-spacing:.2px;
    }
    .navTitle span{
      font-size: 12px;
      color: var(--muted);
    }

    .navLinks{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:center;
    }

    .navLinks a{
      text-decoration:none;
      color: rgba(233,238,251,.86);
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      transition: .15s ease;
    }
    .navLinks a:hover{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      transform: translateY(-1px);
    }

    .navRight{
      display:flex;
      align-items:center;
      gap: 10px;
      justify-content:flex-end;
      min-width: 220px;
    }

    .navSearch{
      width: 220px;
      max-width: 40vw;
    }

    @media (max-width: 900px){
      .navLeft, .navRight{ min-width: auto; }
      .navSearch{ width: 160px; }
    }

    /* Right column stacking */
    .rightStack{
      display:grid;
      gap: 14px;
      align-items:start;
    }
    .lowerRow{
    grid-template-columns: 1fr;
  }

  </style>
</head>

<body>
  {% include "navbar.html" %}

  <div class="page">
    <div class="headerRow">
      <div class="crumbs" aria-label="Breadcrumbs">
        <a href="/">Dashboard</a>
        <span class="sep">›</span>
        <span class="k">Scripts</span>
      </div>

      <div class="actions">
        <a class="btn" href="#" id="btnSave">Save Strategy</a>
        <a class="btn good" href="#" id="btnLive">Go Live</a>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Editor -->
      <section class="panel" aria-label="Code Editor">
        <div class="panelHead">
          <div class="panelTitle">
            <span class="dotLamp" aria-hidden="true"></span>
            <strong>Strategy Code</strong>
          </div>
          <div class="smallMeta">
            <span class="pill"><span class="muted">Entry:</span> <span id="entryName">main.py</span></span>
          </div>
        </div>

       <div class="editorGrid">
  <!-- Top: editor -->
  <div class="editorTop">
    <textarea id="code" class="editor" spellcheck="false"># main.py
def run(data, params):
    return {"message": "hello", "params": params}
</textarea>
  </div>

  <!-- Bottom: JSON feed -->
  <div class="lowerRow">
    <div class="miniPanel" aria-label="JSON Live Feed">
      <div class="miniHead">
        <strong>JSON Live Feed</strong>
        <span class="pill"><span class="muted">Mode:</span> <span id="feedMode">mock</span></span>
        <span class="pill"><span class="muted">Last:</span> <span id="feedLast">—</span></span>
      </div>

      <div class="miniBody">
        <div class="feed" id="liveFeed">{}</div>
      </div>
    </div>
  </div>
</div> <!-- ✅ CLOSE editorGrid -->

<div class="editorFoot">
  <span class="pill"><span class="muted">Ctrl/⌘ + Enter:</span> Run</span>
  <span class="pill"><span class="muted">Autosave:</span> <span id="autosave">Off</span></span>
  <span class="pill"><span class="muted">Lines:</span> <span id="lineCount">—</span></span>
</div>
      </section>

      <!-- RIGHT: Controls + Output + Big Chart -->
      <div class="rightStack">
        <section class="panel" aria-label="Run Panel">
          <div class="tabs" role="tablist" aria-label="Run Panel Tabs">
            <button class="tab active" data-tab="quick" role="tab" aria-selected="true" type="button">Quick Run</button>
            <button class="tab" data-tab="desc" role="tab" aria-selected="false" type="button">Description</button>
            <button class="tab" data-tab="params" role="tab" aria-selected="false" type="button">Parameters</button>
          </div>

          <div class="tabBody">
            <!-- Quick Run -->
            <div class="tabPane" id="tab-quick">
              <div class="row">
                <div>
                  <label for="provider">Dataset / Provider</label>
                  <select id="provider">
                    <option value="yfinance" selected>yfinance</option>
                    <option value="alpaca">alpaca</option>
                  </select>
                </div>

                <div>
                  <label for="symbols">Symbols (comma-separated)</label>
                  <input id="symbols" class="input" type="text" value="SPY" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label for="start">Start Date</label>
                  <input id="start" class="input" type="date" value="2024-01-01" />
                </div>
                <div>
                  <label for="end">End Date</label>
                  <input id="end" class="input" type="date" value="2025-01-01" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label for="capital">Capital</label>
                  <input id="capital" class="input" type="number" min="0" step="1000" value="50000" />
                </div>
                <div>
                  <label for="timeframe">Timeframe</label>
                  <select id="timeframe">
                    <option value="1Day" selected>1Day</option>
                    <option value="1Min">1Min</option>
                  </select>
                </div>
              </div>

              <div class="runRow">
                <a class="btn run" href="#" id="btnRun">Run</a>
                <span class="helper">Runs your current editor code against fetched data and writes artifacts to the run workspace.</span>
              </div>
            </div>

            <!-- Description -->
            <div class="tabPane" id="tab-desc" style="display:none;">
              <label for="strategyName">Strategy Name</label>
              <input id="strategyName" class="input" type="text" value="Buy and Hold" />

              <div style="height:10px"></div>

              <label for="strategyDesc">Description</label>
              <textarea id="strategyDesc" class="input" style="min-height:140px; resize:vertical;">Long-only example strategy. Update this text, then click “Save Strategy”.</textarea>

              <div style="height:10px"></div>
              <div class="helper">
                Tip: store these fields alongside <span class="k">files</span> in your Strategy record so “My Strategies” can show name/description.
              </div>
            </div>

            <!-- Parameters -->
            <div class="tabPane" id="tab-params" style="display:none;">
              <div class="helper">
                Define UI parameters that your script reads (example: risk, rebalance cadence). For MVP, we keep it simple.
              </div>

              <div style="height:10px"></div>

              <div class="row">
                <div>
                  <label for="pRisk">Risk (0–1)</label>
                  <input id="pRisk" class="input" type="number" min="0" max="1" step="0.05" value="0.50" />
                </div>
                <div>
                  <label for="pRebalance">Rebalance</label>
                  <select id="pRebalance">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                  </select>
                </div>
              </div>

              <div class="helper">
                When you wire the runner, send these as a JSON blob (e.g. <span class="k">params_json</span>) with the run request.
              </div>
            </div>
          </div>

          <div class="output" id="output">Output will appear here after “Run”.</div>
        </section>

        <section class="panel bigChart" aria-label="Chart Panel">
          <div class="panelHead">
            <div class="panelTitle">
              <span class="dotLamp" aria-hidden="true"></span>
              <strong>Chart</strong>
            </div>
            <div class="smallMeta">
              <span class="pill"><span class="muted">Source:</span> <span id="chartSource">last run</span></span>
            </div>
          </div>
          <div class="miniBody" style="padding:12px;">
            <div id="tv_chart_container" style="height:320px; width:100%;"></div>

            <div style="height:12px"></div>

            <div class="pill" style="display:inline-flex; margin-bottom:10px;">
              <span class="muted">Overlay:</span>&nbsp;<span id="btLabel">Underlying vs Portfolio</span>
            </div>

            <canvas id="btChart" width="900" height="260"
              style="width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.10);">
            </canvas>
          </div>

          
        </section>
      </div>
    </div>
  </div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
(function () {
  "use strict";

  // --- helpers ---
  const $ = (id) => document.getElementById(id);

  const out = $("output");
  function safeLog(msg) {
    try {
      if (out) out.textContent = String(msg);
      else console.log(msg);
    } catch {}
  }

  function mapInterval(tf){
    if (tf === "1Min") return "1";
    if (tf === "1Day") return "D";
    return "D";
  }

  function normalizeSymbol(sym){
    return (sym || "SPY").trim() || "SPY";
  }

  // --- TradingView ---
  function renderTradingViewChart(){
    const symbolsRaw = $("symbols")?.value || "SPY";
    const symbol = normalizeSymbol(symbolsRaw.split(",")[0]);
    const tf = $("timeframe")?.value || "1Day";
    const interval = mapInterval(tf);

    const chartSource = $("chartSource");
    if (chartSource) chartSource.textContent = `${symbol} · ${interval}`;

    const container = $("tv_chart_container");
    if (!container) return;

    // TradingView needs TradingView global
    if (typeof TradingView === "undefined" || !TradingView.widget) {
      safeLog("TradingView failed to load (TradingView.widget undefined). Check network/CSP.");
      return;
    }

    container.innerHTML = "";

    new TradingView.widget({
      autosize: true,
      symbol,
      interval,
      timezone: "America/New_York",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "rgba(0,0,0,0.18)",
      enable_publishing: false,
      hide_side_toolbar: false,
      allow_symbol_change: true,
      container_id: "tv_chart_container",
    });
  }

  // --- Tabs ---
  function initTabs(){
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const panes = {
      quick: $("tab-quick"),
      desc: $("tab-desc"),
      params: $("tab-params"),
    };

    function setTab(key){
      tabs.forEach(t => {
        const active = t.dataset.tab === key;
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.keys(panes).forEach(k => {
        if (!panes[k]) return;
        panes[k].style.display = (k === key) ? "" : "none";
      });
    }

    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
  }

  // --- Editor UX ---
  function initLineCount(){
    const codeEl = $("code");
    const lineCountEl = $("lineCount");
    if (!codeEl || !lineCountEl) return;

    function updateLineCount(){
      const lines = (codeEl.value.match(/\n/g) || []).length + 1;
      lineCountEl.textContent = String(lines);
    }
    codeEl.addEventListener("input", updateLineCount);
    updateLineCount();
  }

  // --- Live feed (mock) + sync with chart symbol changes ---
  function initFeed(){
    const liveFeedEl = $("liveFeed");
    const feedModeEl = $("feedMode");
    if (feedModeEl) feedModeEl.textContent = "mock";

    if (!liveFeedEl) {
      safeLog("Feed element #liveFeed not found.");
      return;
    }

    let tick = 0;

    function pushFeed(obj){
      const prev = liveFeedEl.textContent.trim();
      const line = typeof obj === "string" ? obj : JSON.stringify(obj);
      const next = (prev && prev !== "{}") ? (prev + "\n" + line) : line;
      liveFeedEl.textContent = next.split("\n").slice(-80).join("\n");
      liveFeedEl.scrollTop = liveFeedEl.scrollHeight;
    }

    // start message
    pushFeed({ t: new Date().toISOString(), type: "status", msg: "feed started" });

    setInterval(() => {
      tick += 1;
      const sym = normalizeSymbol(($("symbols")?.value || "SPY").split(",")[0]);

      // push quote
      pushFeed({
        t: new Date().toISOString(),
        type: "quote",
        sym,
        px: +(480 + Math.sin(tick/8)*3 + (Math.random()-0.5)).toFixed(2),
        vol: Math.floor(1000 + Math.random()*2500)
      });
    }, 1200);
  }

  // --- Run / Save buttons (your existing logic, just wrapped safely) ---
  function initRunSave(){
    const btnRun = $("btnRun");
    const btnSave = $("btnSave");
    const btnLive = $("btnLive");
    const codeEl = $("code");

    function getQuickRunPayload(){
      const provider = $("provider")?.value || "yfinance";
      const symbols = ($("symbols")?.value || "SPY").split(",").map(s => s.trim()).filter(Boolean);
      const start = $("start")?.value || "";
      const end = $("end")?.value || "";
      const timeframe = $("timeframe")?.value || "1Day";
      const capital = Number($("capital")?.value || 0);

      const params = {
        risk: Number($("pRisk")?.value || 0),
        rebalance: $("pRebalance")?.value || "monthly",
        capital,
      };

      return {
        provider,
        symbols,
        start,
        end,
        timeframe,
        timeout_sec: 60,
        entry: "main.py",
        files: { "main.py": codeEl ? codeEl.value : "" },
        params,
      };
    }

    async function runNow(){
      const payload = getQuickRunPayload();
      if (out) out.textContent = "Running…";

      try{
        const res = await fetch("/api/runs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const raw = await res.text();

        if (!ct.includes("application/json")) {
          if (out) out.textContent = `Run error: non-JSON response (HTTP ${res.status})\n\n` + raw.slice(0, 2000);
          return;
        }

        const data = JSON.parse(raw);

        if (!res.ok){
          if (out) out.textContent = "Run failed:\n" + JSON.stringify(data, null, 2);
          return;
        }

        if (out) out.textContent =
          `status=${data.status} exit_code=${data.exit_code}\n\n` +
          `--- stdout ---\n${data.stdout || ""}\n\n` +
          `--- stderr ---\n${data.stderr || ""}\n\n` +
          `--- artifacts ---\n${(data.artifacts || []).map(a => a.name).join("\n")}`;
      }catch(e){
        if (out) out.textContent = "Run error:\n" + (e?.message || String(e));
      }
    }

    async function saveStrategy(){
      const name = ($("strategyName")?.value || "").trim() || "Untitled Strategy";
      const description = $("strategyDesc")?.value || "";
      const payload = { name, description, entry: "main.py", files: { "main.py": codeEl ? codeEl.value : "" } };

      if (out) out.textContent = "Saving strategy…";

      try{
        const res = await fetch("/api/strategies", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const raw = await res.text();

        if (!ct.includes("application/json")) {
          if (out) out.textContent = `Save error: non-JSON response (HTTP ${res.status})\n\n` + raw.slice(0, 2000);
          return;
        }

        const data = JSON.parse(raw);
        if (!res.ok){
          if (out) out.textContent = "Save failed:\n" + JSON.stringify(data, null, 2);
          return;
        }

        if (out) out.textContent = `Saved strategy id=${data.id}\n(Next: show it under “My Strategies” / Strategies page.)`;
      }catch(e){
        if (out) out.textContent = "Save error:\n" + (e?.message || String(e));
      }
    }

    btnRun?.addEventListener("click", (e) => { e.preventDefault(); runNow(); });
    btnSave?.addEventListener("click", (e) => { e.preventDefault(); saveStrategy(); });
    btnLive?.addEventListener("click", (e) => {
      e.preventDefault();
      alert("Go Live is a placeholder. Wire this to your broker connection + live runner.");
    });

    // Ctrl/⌘ + Enter to run
    window.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toLowerCase().includes("mac");
      if ((isMac ? e.metaKey : e.ctrlKey) && e.key === "Enter"){
        e.preventDefault();
        runNow();
      }
    });
  }

  // --- keep chart + feed in sync when user changes symbol/timeframe ---
  function initChartSync(){
    const symbolsEl = $("symbols");
    const timeframeEl = $("timeframe");
    let t = null;

    function debounceRerender(){
      clearTimeout(t);
      t = setTimeout(renderTradingViewChart, 350);
    }

    symbolsEl?.addEventListener("input", debounceRerender);
    timeframeEl?.addEventListener("change", renderTradingViewChart);
  }

  // --- boot ---
  window.addEventListener("load", () => {
    try { initTabs(); } catch (e) { safeLog(e); }
    try { initLineCount(); } catch (e) { safeLog(e); }
    try { initRunSave(); } catch (e) { safeLog(e); }
    try { initFeed(); } catch (e) { safeLog(e); }
    try { renderTradingViewChart(); } catch (e) { safeLog(e); }
    try { initChartSync(); } catch (e) { safeLog(e); }
  });

})();
</script>
<script>
  const codeEl = document.getElementById("code");
  const out = document.getElementById("output");

  // Treat the editor as the source of truth for the run
  const ENTRY_PATH = "strategy/main.py";

  function getQuickRunPayload(){
    const provider = document.getElementById("provider").value;
    const symbols = document.getElementById("symbols").value
      .split(",").map(s => s.trim()).filter(Boolean);

    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    const timeframe = document.getElementById("timeframe").value;
    const capital = Number(document.getElementById("capital").value || 0);

    const params = {
      risk: Number(document.getElementById("pRisk")?.value || 0),
      rebalance: document.getElementById("pRebalance")?.value || "monthly",
      capital,
      provider,
      symbols,
      start,
      end,
      timeframe,
    };

    return {
      provider,
      symbols,
      start,
      end,
      timeframe,
      timeout_sec: 60,

      // ✅ run whatever is in the editor
      entry: ENTRY_PATH,
      files: { [ENTRY_PATH]: codeEl.value },

      // optional extras your runner may use
      params,
    };
  }

  async function runNow(){
    const payload = getQuickRunPayload();
    out.textContent = "Running…";

    try{
      const res = await fetch("/api/runs", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(payload),
      });

      const ct = (res.headers.get("content-type") || "").toLowerCase();
      const raw = await res.text();

      if (!ct.includes("application/json")){
        out.textContent = `Run error: non-JSON response (HTTP ${res.status})\n\n` + raw.slice(0, 2000);
        return;
      }

      const data = JSON.parse(raw);

      if (!res.ok){
        out.textContent = "Run failed:\n" + JSON.stringify(data, null, 2);
        return;
      }

      out.textContent =
        `status=${data.status} exit_code=${data.exit_code}\n\n` +
        `--- stdout ---\n${data.stdout || ""}\n\n` +
        `--- stderr ---\n${data.stderr || ""}\n\n` +
        `--- artifacts ---\n${(data.artifacts || []).map(a => a.name).join("\n")}`;
    }catch(e){
      out.textContent = "Run error:\n" + (e?.message || String(e));
    }
  }

  // Hook your Run button
  document.getElementById("btnRun")?.addEventListener("click", (e) => {
    e.preventDefault();
    runNow();
  });

  // Ctrl/⌘ + Enter to run
  window.addEventListener("keydown", (e) => {
    const isMac = navigator.platform.toLowerCase().includes("mac");
    const mod = isMac ? e.metaKey : e.ctrlKey;
    if (mod && e.key === "Enter"){
      e.preventDefault();
      runNow();
    }
  });

  // ===== Mode toggle + overlay chart =====
const modeSelect = document.getElementById("modeSelect");
const btCanvas = document.getElementById("btChart");
const btLabel = document.getElementById("btLabel");
const feedLastEl = document.getElementById("feedLast");

let overlayUnderlying = []; // normalized series
let overlayEquity = [];     // normalized series

function normalizeTo100(arr){
  if (!arr?.length) return [];
  const base = Number(arr[0]) || 1;
  if (!base) return arr.map(() => 100);
  return arr.map(v => 100 * (Number(v) / base));
}

function drawTwoLineChart(canvas, seriesA, seriesB){
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.fillStyle = "rgba(0,0,0,0.12)";
  ctx.fillRect(0,0,w,h);

  if (!seriesA?.length || !seriesB?.length) return;

  const n = Math.min(seriesA.length, seriesB.length);
  const A = seriesA.slice(-n);
  const B = seriesB.slice(-n);

  const all = A.concat(B);
  const min = Math.min(...all);
  const max = Math.max(...all);
  const span = (max - min) || 1;
  const pad = 18;

  // grid
  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  ctx.lineWidth = 1;
  for (let i=1;i<=3;i++){
    const y = pad + (h-2*pad)*(i/4);
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(w-pad, y);
    ctx.stroke();
  }

  function plot(points, stroke){
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2;
    ctx.beginPath();
    points.forEach((v, i) => {
      const x = pad + (w-2*pad) * (i/(points.length-1));
      const y = pad + (h-2*pad) * (1 - ((v - min)/span));
      if (i === 0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  // underlying (cyan) + equity (violet)
  plot(A, "rgba(34,211,238,0.9)");
  plot(B, "rgba(99,102,241,0.9)");
}

function resetOverlay(){
  overlayUnderlying = [];
  overlayEquity = [];
  drawTwoLineChart(btCanvas, [], []);
}

function updateOverlayLive(px){
  // In live mode, we just track underlying and pretend equity ~= underlying (for demo)
  overlayUnderlying.push(px);
  overlayEquity.push(px);

  const u = normalizeTo100(overlayUnderlying);
  const e = normalizeTo100(overlayEquity);
  drawTwoLineChart(btCanvas, u, e);
}

function simulateBacktestOverlay(){
  // For now: equity lags underlying slightly (demo)
  const n = 140;
  let u = 100;
  let e = 100;
  const uArr = [];
  const eArr = [];

  for (let i=0;i<n;i++){
    u *= (1 + (Math.random()-0.5)*0.004);        // underlying
    e *= (1 + (Math.random()-0.5)*0.002 + 0.0002); // smoother equity w/ slight drift
    uArr.push(u);
    eArr.push(e);
  }

  overlayUnderlying = uArr;
  overlayEquity = eArr;

  drawTwoLineChart(btCanvas, normalizeTo100(uArr), normalizeTo100(eArr));
  if (btLabel) btLabel.textContent = "Underlying vs Portfolio (SIM)";
}

// hook mode select
if (modeSelect){
  modeSelect.addEventListener("change", () => {
    const mode = modeSelect.value;
    resetOverlay();
    if (btLabel){
      btLabel.textContent = mode === "live"
        ? "Underlying vs Portfolio (Live demo)"
        : "Underlying vs Portfolio (Backtest)";
    }
  });
}

// ===== Patch your existing pushFeed to also update last tick + overlay =====
// If you already have pushFeed(), replace it with this version OR merge the lines in.
const _origPushFeed = typeof pushFeed === "function" ? pushFeed : null;

function pushFeedPatched(obj){
  // keep your existing behavior
  if (_origPushFeed) _origPushFeed(obj);
  else {
    // minimal fallback if you didn't define pushFeed earlier
    const liveFeedEl = document.getElementById("liveFeed");
    if (liveFeedEl){
      const prev = liveFeedEl.textContent.trim();
      const line = typeof obj === "string" ? obj : JSON.stringify(obj);
      const next = (prev && prev !== "{}") ? (prev + "\n" + line) : line;
      liveFeedEl.textContent = next.split("\n").slice(-80).join("\n");
      liveFeedEl.scrollTop = liveFeedEl.scrollHeight;
    }
  }

  // update "Last" pill + overlay chart if it is a quote
  if (obj && typeof obj === "object" && obj.type === "quote"){
    if (feedLastEl){
      feedLastEl.textContent = `${obj.sym} ${obj.px}`;
    }
    const mode = modeSelect ? modeSelect.value : "live";
    if (mode === "live"){
      const px = Number(obj.px);
      if (Number.isFinite(px)) updateOverlayLive(px);
    }
  }
}

// IMPORTANT: make the rest of your code call pushFeedPatched
// If you call pushFeed(...) in your interval, change it to pushFeedPatched(...)

</script>


  {% include "footer.html" %}
</body>
</html>
<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  // ----------- output helper -----------
  const out = $("output");
  function writeOutput(text){
    if (out) out.textContent = String(text);
    else console.log(text);
  }

  // ----------- TradingView test -----------
  function mapInterval(tf){
    if (tf === "1Min") return "1";
    if (tf === "1Day") return "D";
    return "D";
  }

  function normalizeSymbol(sym){
    return (sym || "SPY").trim() || "SPY";
  }

  function renderTradingViewChart(){
    const container = $("tv_chart_container");
    if (!container) return;

    const symbolsRaw = $("symbols")?.value || "SPY";
    const symbol = normalizeSymbol(symbolsRaw.split(",")[0]);
    const tf = $("timeframe")?.value || "1Day";
    const interval = mapInterval(tf);

    const chartSource = $("chartSource");
    if (chartSource) chartSource.textContent = `${symbol} · ${interval}`;

    container.innerHTML = "";

    if (typeof TradingView === "undefined" || !TradingView.widget){
      writeOutput("TradingView failed to load. Check DevTools Console/Network or CSP blocking https://s3.tradingview.com/tv.js");
      return;
    }

    new TradingView.widget({
      autosize: true,
      symbol,
      interval,
      timezone: "America/New_York",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "rgba(0,0,0,0.18)",
      enable_publishing: false,
      hide_side_toolbar: false,
      allow_symbol_change: true,
      container_id: "tv_chart_container",
    });
  }

  // ----------- Live feed test (mock) -----------
  const liveFeedEl = $("liveFeed");
  const feedModeEl = $("feedMode");
  const feedLastEl = $("feedLast");

  let tick = 0;
  let feedTimer = null;

  function pushFeed(obj){
    if (!liveFeedEl) return;
    const prev = liveFeedEl.textContent.trim();
    const line = typeof obj === "string" ? obj : JSON.stringify(obj);
    const next = (prev && prev !== "{}") ? (prev + "\n" + line) : line;
    liveFeedEl.textContent = next.split("\n").slice(-120).join("\n");
    liveFeedEl.scrollTop = liveFeedEl.scrollHeight;

    // show last px in the header pill
    if (obj && typeof obj === "object" && obj.px != null && feedLastEl){
      feedLastEl.textContent = `${obj.sym} ${obj.px}`;
    }
  }

  function startFeed(){
    if (feedTimer) clearInterval(feedTimer);

    if (feedModeEl) feedModeEl.textContent = "mock";
    if (feedLastEl) feedLastEl.textContent = "—";
    if (liveFeedEl) liveFeedEl.textContent = "{}";

    tick = 0;
    pushFeed({ t: new Date().toISOString(), type: "status", msg: "feed started" });

    feedTimer = setInterval(() => {
      tick += 1;

      const sym = normalizeSymbol(($("symbols")?.value || "SPY").split(",")[0]);
      const base = 480 + Math.sin(tick/8)*3;
      const px = +(base + (Math.random()-0.5)).toFixed(2);

      pushFeed({
        t: new Date().toISOString(),
        type: "quote",
        sym,
        px,
        vol: Math.floor(1000 + Math.random()*2500)
      });
    }, 900);
  }

  // ----------- “Simulate Run” test -----------
  function simulateRun(){
    const payload = {
      provider: $("provider")?.value,
      symbols: ($("symbols")?.value || "SPY").split(",").map(s => s.trim()).filter(Boolean),
      start: $("start")?.value,
      end: $("end")?.value,
      timeframe: $("timeframe")?.value,
      capital: Number($("capital")?.value || 0),
      params: {
        risk: Number($("pRisk")?.value || 0),
        rebalance: $("pRebalance")?.value || "monthly",
      }
    };

    // fake “runner” result
    const fake = {
      status: "ok",
      exit_code: 0,
      stdout: "Backtest complete.\nTrades: 2\nSharpe: 0.92\nMaxDD: -4.1%",
      stderr: "",
      artifacts: [
        { name: "equity_curve.json" },
        { name: "trades.csv" },
        { name: "metrics.json" }
      ]
    };

    writeOutput(
      `SIMULATED RUN (no backend)\n\n` +
      `payload:\n${JSON.stringify(payload, null, 2)}\n\n` +
      `status=${fake.status} exit_code=${fake.exit_code}\n\n` +
      `--- stdout ---\n${fake.stdout}\n\n` +
      `--- stderr ---\n${fake.stderr}\n\n` +
      `--- artifacts ---\n${fake.artifacts.map(a => a.name).join("\n")}`
    );

    // also inject a “run event” into the feed so you see the UI react
    pushFeed({ t: new Date().toISOString(), type: "run", msg: "simulated run completed", sym: payload.symbols[0] || "SPY" });
  }

  // ----------- wiring: sync changes -----------
  function initSync(){
    const symbolsEl = $("symbols");
    const timeframeEl = $("timeframe");
    let debounce = null;

    function rerenderAll(){
      renderTradingViewChart();
      startFeed(); // resets feed to match new symbol/timeframe
      pushFeed({ t: new Date().toISOString(), type: "status", msg: "synced chart+feed" });
    }

    if (symbolsEl){
      symbolsEl.addEventListener("input", () => {
        clearTimeout(debounce);
        debounce = setTimeout(rerenderAll, 350);
      });
    }

    if (timeframeEl){
      timeframeEl.addEventListener("change", rerenderAll);
    }
  }

  // attach simulate button if present
  function initSimButton(){
    const btnSim = $("btnSim");
    if (!btnSim) return;
    btnSim.addEventListener("click", (e) => {
      e.preventDefault();
      simulateRun();
    });
  }

  // boot
  window.addEventListener("load", () => {
    renderTradingViewChart();
    startFeed();
    initSync();
    initSimButton();
  });
})();
</script>
